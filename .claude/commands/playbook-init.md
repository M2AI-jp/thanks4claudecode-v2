# /init - 新しいタスク開始フロー

> **このフローは構造的に強制される。手順をスキップしてはならない。**

---

## Step -1: 再実行チェック（必須・自動実行）

以下のコマンドを**必ず実行**し、playbook の状態を確認せよ：

```bash
echo "=== Step -1: 再実行チェック ===" && \
echo "1. 既存の playbook:" && ls plan/active/playbook-*.md 2>/dev/null || echo "(なし)" && \
echo "2. playbook の branch:" && grep "^branch:" plan/active/playbook-*.md 2>/dev/null | head -1 || echo "(なし)" && \
echo "3. in_progress の Phase:" && grep -A1 "status: in_progress" plan/active/playbook-*.md 2>/dev/null | head -3 || echo "(なし)"
```

### 判定フロー

| 条件 | 対応 |
|------|------|
| playbook なし | → Step 0 へ進む |
| playbook あり & in_progress Phase なし | → ユーザーに確認（下記参照） |
| playbook あり & in_progress Phase あり | → **STOP** → タスク中断の確認が必要 |

### playbook が既に存在する場合

ユーザーに以下を確認せよ：

```
既存の playbook が見つかりました: plan/active/playbook-{name}.md

選択肢:
1. 既存の playbook を上書きする（現在のタスクを破棄）
2. 新しいブランチで別の playbook を作成する
3. キャンセルして既存のタスクを続行する

どれを選びますか？
```

### in_progress の Phase がある場合

```
⚠️ 進行中のタスクがあります:
  - {Phase 名}: in_progress

このタスクを中断して新しいタスクを開始しますか？
中断する場合、既存の playbook は plan/archive/ に移動されます。

[中断して新規作成] / [キャンセル]
```

---

## Step 0: 前提条件チェック（必須・自動実行）

以下のコマンドを**必ず実行**し、結果を確認せよ：

```bash
echo "=== Step 0: 前提条件チェック ===" && \
echo "1. 未コミット変更:" && git status --short && \
echo "2. 現在のブランチ:" && git branch --show-current && \
echo "3. 未 push コミット:" && git log --oneline @{u}..HEAD 2>/dev/null || echo "(upstream なし)"
```

### チェック項目

| 条件 | 対応 |
|------|------|
| 未コミット変更がある | **STOP** → 先にコミットせよ |
| main ブランチにいる | OK（Step 1 でブランチを切る） |
| 未 push コミットがある | 警告 → push を検討 |

**未コミット変更がある場合、このフローを続行してはならない。**

---

## Step 1: ブランチ作成（必須）

### 1.1 ブランチ名の自動決定

**ユーザーの要求内容からブランチ名を自動推論**せよ。質問するな。

| 要求の種類 | ブランチ名パターン |
|-----------|-------------------|
| 新機能追加 | feat/{機能名を kebab-case に} |
| バグ修正 | fix/{問題の短い説明} |
| リファクタリング | refactor/{対象} |
| ドキュメント | docs/{対象} |
| テスト | test/{対象} |

**推論の例:**
- 「ユーザー認証を追加して」→ `feat/user-authentication`
- 「ログインできないバグを直して」→ `fix/login-bug`
- 「API の構造を整理して」→ `refactor/api-structure`

### 1.2 ブランチ作成（自動実行）

**推論したブランチ名で即座に実行**（確認不要）：

```bash
git checkout -b {推論したブランチ名}
```

**ブランチを作成するまで次のステップに進んではならない。**

---

## Step 2: playbook 自動生成（必須）

**ユーザーの最初の要求から以下を自動推論**せよ。追加の質問は禁止。

1. **ゴール**: 要求の本質を 1 行で要約
2. **done_criteria**: 完了条件をテスト可能な形式で列挙
3. **phases**: 論理的なフェーズに分割

**推論できない場合のみ**、最小限の確認を行う（「何を作りますか？」ではなく「〇〇という理解で合っていますか？」）

---

## Step 3: playbook 作成（自動実行）

### 3.1 ファイル作成

`plan/playbook-{project-name}.md` を作成。

**重要**: `branch:` フィールドには **Step 1 で作成したブランチ名を自動設定**せよ。

```yaml
meta:
  project: {プロジェクト名}
  branch: {Step 1 で作成したブランチ名}  # ← 自動設定（手入力禁止）
  created: {今日の日付}

goal:
  summary: {1行の目標}
  done_when:
    - {最終完了条件}

phases:
  - id: p1
    name: {フェーズ名}
    goal: {目標}
    executor: codex
    done_criteria:
      - {完了条件}
    status: pending
```

### 3.2 整合性確認

playbook 作成後、以下を実行して整合性を確認：

```bash
echo "=== 整合性確認 ===" && \
echo "現在のブランチ:" && git branch --show-current && \
echo "playbook の branch:" && grep "^branch:" plan/playbook-*.md | tail -1
```

**両者が一致していなければ、playbook を修正せよ。**

---

## Step 4: state.md 更新（自動実行）

該当レイヤーの以下を更新：

1. `playbook:` → 作成した playbook のパス
2. `state:` → `implementing`
3. `sub:` → 新しいバージョン名

```yaml
# 例: workspace レイヤーの場合
state: implementing
sub: v{N}-{description}
playbook: plan/playbook-{project-name}.md
```

---

## Step 5: 最終確認（自動実行）

以下を実行して全体の整合性を確認：

```bash
bash .claude/hooks/check-coherence.sh
```

**ERROR がある場合、修正するまで作業を開始してはならない。**

---

## フロー図

```
┌─────────────────────────────────────────────────┐
│ /init 実行                                       │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│ Step -1: 再実行チェック                          │
│   - playbook あり & in_progress? → STOP          │
│   - playbook あり? → ユーザーに確認              │
│   - playbook なし? → 続行                        │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│ Step 0: 前提条件チェック                         │
│   - 未コミット変更あり? → STOP                   │
│   - main ブランチ? → OK（次で切る）              │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│ Step 1: ブランチ作成                             │
│   - ユーザーにブランチ名をヒアリング             │
│   - git checkout -b {branch}                    │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│ Step 2: playbook ヒアリング                      │
│   - 何を作るか                                   │
│   - 完了条件は何か                               │
│   - フェーズ分割                                 │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│ Step 3: playbook 作成                            │
│   - branch: は Step 1 のブランチを自動設定       │
│   - 整合性確認                                   │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│ Step 4: state.md 更新                            │
│   - playbook:, state:, sub: を更新               │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│ Step 5: 最終確認                                 │
│   - check-coherence.sh で整合性チェック          │
│   - ERROR なし → 作業開始可能                    │
└─────────────────────────────────────────────────┘
```

---

## 禁止事項

```
❌ Step 0 をスキップして playbook 作成を始める
❌ 未コミット変更がある状態で新しいタスクを始める
❌ ブランチを作成せずに playbook を作成する
❌ playbook の branch: を手入力する（現在のブランチを自動取得）
❌ check-coherence.sh で ERROR があるまま作業を開始する
```

---

## 変更履歴

| 日時 | 内容 |
|------|------|
| 2025-12-02 | V3: Step -1（再実行チェック）を追加。playbook 再作成時の挙動を明確化。 |
| 2025-12-02 | V2: 構造的強制を追加。Step 0（前提条件チェック）、自動実行ステップを明確化。 |
| 2025-12-01 | V1: 初版作成。 |
