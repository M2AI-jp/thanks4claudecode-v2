#!/bin/bash
# ============================================================
# consent-guard.sh - 合意プロセス強制フック
# ============================================================
# 発火条件: PreToolUse:Edit/Write
# 目的: ユーザーとの合意なしで Edit/Write をブロック
#
# 【設計意図】
# Claude がユーザープロンプトを「良かれと思って省略」し、
# 意図しない大規模変更を行う問題を構造的に防止する。
#
# 【フロー】
# 1. ユーザープロンプト受信
# 2. LLM が [理解確認] ブロックを出力
# 3. ユーザーが OK/修正/却下 を選択
# 4. OK の場合のみ consent ファイルを作成
# 5. consent ファイルがある場合のみ Edit/Write 許可
#
# 【注意】
# - このフックは settings.json に未登録（設計検証段階）
# - 実際の運用には session-start.sh との統合が必要
# ============================================================

set -euo pipefail

# ============================================================
# Admin モードチェック（最優先）
# ============================================================
STATE_FILE="state.md"
if [ -f "$STATE_FILE" ]; then
    SECURITY=$(grep -A3 "^## config" "$STATE_FILE" 2>/dev/null | grep "security:" | head -1 | sed 's/security: *//' | tr -d ' ')
    if [[ "$SECURITY" == "admin" ]]; then
        # admin モードは全ての制限をバイパス
        exit 0
    fi
fi

# ============================================================
# 設定
# ============================================================
CONSENT_DIR="${HOME}/Desktop/thanks4claudecode/.claude/.session-init"
CONSENT_FILE="${CONSENT_DIR}/consent"

# ============================================================
# 入力解析
# ============================================================
INPUT=$(cat)
TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // empty')

# ============================================================
# 対象ツールチェック
# ============================================================
case "$TOOL_NAME" in
    Edit|Write)
        # 合意チェック対象
        ;;
    *)
        # 対象外ツールは通過
        exit 0
        ;;
esac

# ============================================================
# 合意ファイル存在チェック（pending 方式）
# ============================================================
# consent ファイルが存在する = 未合意（pending）→ ブロック
# consent ファイルが存在しない = 合意済み → 通過
#
# フロー:
#   1. session-start.sh が consent ファイルを作成（pending 状態）
#   2. [理解確認] 出力 → ユーザー OK
#   3. consent ファイルを削除（合意済み）
#   4. Edit/Write が許可される
# ============================================================
if [ -f "$CONSENT_FILE" ]; then
    cat << 'EOF'
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ⛔ 合意プロセス未完了 - Edit/Write をブロック
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  [理解確認] ブロックを出力し、ユーザーの合意を得てください。

  フォーマット:
    [理解確認]
    what: 「〇〇をすること」と理解しました
    why: 目的は「△△」と推測します
    how: 以下の手順で進めます
    scope: 変更対象ファイル
    exclusions: 変更しないファイル
    risks: |
      リスク1_{カテゴリ}:
        問題: {失敗の可能性}
        影響: {影響度}
        対策: {防止策}

  ⚠️ risks は必須です。3-5個のリスクを分析してください。

  ユーザーが「OK」と応答したら:
    rm .claude/.session-init/consent
  を実行して作業を開始できます。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
EOF
    exit 2
fi

# ============================================================
# 合意済み（consent ファイルが存在しない）- 通過
# ============================================================
exit 0
