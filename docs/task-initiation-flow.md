# タスク開始フロー図

> **標準タスク開始プロセス - 品質の一貫性を保証**
>
> 全てのタスクは project.md からの導出を経由する。
> pm SubAgent が必須経由点として機能する。

---

## 概要

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        タスク開始フロー                                   │
│                                                                          │
│   ユーザー要求 → pm SubAgent → project.md 参照 → playbook 作成 → LOOP    │
│                                                                          │
│   ★ pm を経由しないタスク開始は禁止                                       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 詳細フロー

```
                    ┌─────────────────┐
                    │  ユーザー要求    │
                    │  「〇〇を実装」  │
                    └────────┬────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │      /task-start 発火         │
              │      または Claude 判断       │
              └──────────────┬───────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────┐
        │              pm SubAgent                    │
        │  ★ タスク開始の必須経由点                   │
        └────────────────────┬───────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────┐
        │           project.md 参照                   │
        │                                             │
        │  1. done_when の一覧を取得                  │
        │  2. not_achieved のタスクを特定             │
        │  3. depends_on を解決                       │
        │  4. 着手可能なタスクを決定                  │
        └────────────────────┬───────────────────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
                    ▼                 ▼
          ┌─────────────────┐  ┌─────────────────────┐
          │ 該当タスクあり   │  │ 該当タスクなし       │
          └────────┬────────┘  └──────────┬──────────┘
                   │                       │
                   │                       ▼
                   │            ┌─────────────────────┐
                   │            │ project.md に       │
                   │            │ 新規 done_when 追加 │
                   │            └──────────┬──────────┘
                   │                       │
                   └───────────┬───────────┘
                               │
                               ▼
        ┌────────────────────────────────────────────┐
        │           ブランチ作成                      │
        │                                             │
        │  git checkout -b feat/{task-name}          │
        │  ※ main からの分岐                         │
        └────────────────────┬───────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────┐
        │           playbook 作成                     │
        │                                             │
        │  1. derives_from を設定（必須）             │
        │  2. decomposition を参照                   │
        │  3. Phase を構成                           │
        │  4. plan/active/playbook-{name}.md 作成    │
        └────────────────────┬───────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────┐
        │           state.md 更新                     │
        │                                             │
        │  - active_playbooks.product を更新         │
        │  - goal を更新                             │
        │  - verification.self_complete = false      │
        └────────────────────┬───────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────┐
        │           LOOP 開始                         │
        │                                             │
        │  Phase 1 から done_criteria に従って実行   │
        └────────────────────────────────────────────┘
```

---

## 禁止パターン

```
❌ 禁止パターン 1: pm を経由しない直接作成
  ┌─────────────────┐
  │  ユーザー要求    │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │  直接 playbook  │  ← これは禁止
  │  作成           │
  └─────────────────┘

❌ 禁止パターン 2: project.md 参照なし
  ┌─────────────────┐
  │  pm SubAgent    │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │  playbook 作成  │  ← project.md 参照なしは禁止
  │  (derives_from  │
  │   なし)         │
  └─────────────────┘

❌ 禁止パターン 3: main ブランチでの作業
  ┌─────────────────┐
  │  main ブランチ   │
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │  直接編集       │  ← main での直接作業は禁止
  └─────────────────┘
```

---

## playbook 完了後のフロー（POST_LOOP）

```
        ┌────────────────────────────────────────────┐
        │        playbook 全 Phase 完了               │
        └────────────────────┬───────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────┐
        │        project.md 更新                      │
        │                                             │
        │  derives_from の done_when.status を        │
        │  achieved に変更                           │
        └────────────────────┬───────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────┐
        │        pm SubAgent 呼び出し                 │
        │  ★ 次タスク導出も pm 経由                   │
        └────────────────────┬───────────────────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
                    ▼                 ▼
          ┌─────────────────┐  ┌─────────────────────┐
          │ 残タスクあり     │  │ 残タスクなし         │
          └────────┬────────┘  └──────────┬──────────┘
                   │                       │
                   ▼                       ▼
          ┌─────────────────┐  ┌─────────────────────┐
          │ 次の playbook   │  │ 「全タスク完了」     │
          │ を自動作成      │  │                      │
          │ → LOOP 開始     │  └─────────────────────┘
          └─────────────────┘
```

---

## derives_from の重要性

```yaml
目的:
  - タスクと上位計画の紐付け
  - 完了時に project.md の自動更新
  - トレーサビリティの確保

形式:
  derives_from: project.md / {セクション名} / {done_when.id}

例:
  derives_from: project.md / system_completion / dw_sc_1_task_standardization
  derives_from: project.md / engineering_ecosystem / dw_2_linter_formatter

必須条件:
  - 全ての playbook は derives_from を持つ
  - derives_from なしの playbook は作成禁止
```

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| .claude/agents/pm.md | pm SubAgent（タスク開始の必須経由点） |
| .claude/commands/task-start.md | /task-start コマンド |
| CLAUDE.md | INIT/POST_LOOP の pm 経由ルール |
| plan/project.md | done_when の管理（Macro 計画） |

---

## 変更履歴

| 日時 | 内容 |
|------|------|
| 2025-12-09 | 初版作成。タスク開始プロセス標準化の成果物。 |
